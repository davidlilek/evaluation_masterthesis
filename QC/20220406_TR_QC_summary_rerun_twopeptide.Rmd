---
title: "DataAnalysis - Postprocessing Results MaxQuant"
autor: David Lilek
date: "`r format(Sys.time(), '%d %B %Y, %X')`"
output:
  html_document:
    df_print: paged
    fig.align: center
    self_contained: yes
    fig.height: 4
    fig.width: 8
    theme: united
    toc: yes
    toc_depth: 4
    toc_float: yes
    number_sections: yes
    code_folding: hide
---

```{r start, message=FALSE, warning=FALSE, include=FALSE}
start_time = format(Sys.time(), '%X')
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE}
#load libraries
library(tidyverse)
library(dplyr)
library(gplots)
library(reshape2) #for melting data for boxplot with ggplot
library(pheatmap)
library(MASS)
library(ggpubr)
library(RColorBrewer)
```


```{r results="asis"}
###############################
#
#define settings
#
###############################

path = "N:/1_A_Bachelor_Master_Intern/00_M_2022/David/Data/evaluation_masterthesis/QC/tmpfiles/qc_twouniquepeptide/"

##########read in all data with pattern .txt
# get file list
file.list <- list.files(path = path, pattern='*.csv')
file.list <- file.list[-c(3,7)]
# create file path
file.path <- paste(path,file.list,sep = "")
# read in files - for each file one variable is created - results are stored in a list
res_raw <- lapply(file.path, function(i){read.csv2(i, row.names = 1)})
names(res_raw) <- file.list
```

```{r}
#create data.frame
res<-as.data.frame(res_raw)
rownames(res) <- NULL
```

```{r}
#functions
CV <- function(x){
  (sd(x)/mean(x))*100
}

MEAN <- function(x){
  mean(x)
}
```


# Razor

```{r}
razor <- res[,grep("Razor",colnames(res))]
colnames(razor) <- c("MBR_pooled","MBR_pooled\noldversion","MBR","noMBR_pooled","noMBR_pooled\noldversion","noMBR")
boxplot(razor)
apply(razor,2,CV)
```

# Unique

```{r}
unique <- res[,grep("Unique",colnames(res))]
colnames(unique) <- c("MBR_pooled","MBR_pooled\noldversion","MBR","noMBR_pooled","noMBR_pooled\noldversion","noMBR")
boxplot(unique)
apply(unique,2,CV)
```
# LFQ

```{r}
lfq <- res[,grep("LFQ",colnames(res))]
colnames(lfq) <- c("MBR_pooled","MBR_pooled\noldversion","MBR","noMBR_pooled","noMBR_pooled\noldversion","noMBR")
boxplot(lfq)
apply(lfq,2,CV)
```


# visualize no protein identifications and rsd

```{r}
#plot data
no <- c(apply(razor,2,MEAN),apply(unique,2,MEAN),apply(lfq,2,MEAN))
rsd <- c(apply(razor,2,CV),apply(unique,2,CV),apply(lfq,2,CV))
evaluation <- rep(c("MBR_pooled","MBR_pooled_oldversion","MBR","noMBR_pooled","noMBR_pooled_oldversion","noMBR"),3)

type <- c("Razor","Unique","LFQ")
type <- rep(type, each=6)

df <- data.frame(no, type, evaluation,rsd)
colnames(df) <- c("no","Type","Evaluation","rsd")

#reorder x axis
df$Type <- factor(df$Type,
                  levels = c("Razor","Unique","LFQ"))
df$Evaluation <- factor(df$Evaluation,
                               levels = c("MBR_pooled","MBR_pooled_oldversion","MBR","noMBR_pooled","noMBR_pooled_oldversion","noMBR"))

mypalette_red <-brewer.pal(9,"PuRd")
#reverse color to get the more intense for MBR
mypalette_red <- rev(mypalette_red[c(7:9)])
mypalette_blue <-brewer.pal(9,"PuBu")
mypalette_blue <- rev(mypalette_blue[c(7:9)])

color_manual <- rep(c(mypalette_red,mypalette_blue),3)

plot <- ggplot(df, aes(x=Type, y=no, fill=Evaluation)) +
  geom_bar(stat='identity', position=position_dodge()) +
  geom_errorbar(aes(ymin = (no-((rsd/2))*100), ymax = (no+((rsd/2))*100)),width=0.2, position = position_dodge(0.9)) +
  theme_minimal() +
  scale_fill_manual(values = alpha(color_manual,0.8)) +
  theme(legend.position="bottom") +
  theme(legend.key.size = unit(0.15, 'cm')) +
  guides(fill=guide_legend(nrow=2, byrow=TRUE)) +
  ylab("No. of protein identifications") +
  labs(fill = "Evaluation \n method", title = "two peptides") +
  coord_cartesian(ylim=c(1200,2000)) +
  geom_text(aes(label=round(no,0)), position = position_dodge(width = 0.9), hjust = 2, vjust=0.4, angle = 90)
plot
saveRDS(plot, file = "plot_qc_twopeptides.rds")
```

```{r}
saveRDS(df, file = "20220406_TR_QC_summary_rerun_twopeptides.rds")
```


# Relative deviations



```{r}
df.clear <- df

### - mean
df.clear$meandiff[1:6] <- df.clear$no[1:6]-median(df.clear$no[1:6])
df.clear$meandiff[7:12] <- df.clear$no[7:12]-median(df.clear$no[7:12])
df.clear$meandiff[13:18] <- df.clear$no[13:18]-median(df.clear$no[13:18])
p_plot_two <- ggplot(df.clear, aes(x=Type, y=meandiff, fill=Evaluation)) +
  geom_bar(stat='identity', position=position_dodge()) +
  theme_minimal() +
  scale_fill_brewer(palette="Dark2") +
  theme(legend.position="bottom") +
  theme(legend.key.size = unit(0.15, 'cm')) +
  guides(fill=guide_legend(nrow=2, byrow=TRUE)) +
  ylab("No. of protein identifications\n Deviation from median(type)") +
  labs(fill = "Evaluation \n method")
p_plot_two


### - mean/mean *100
df.clear <- df
df.clear$meandiff[1:6] <- (df.clear$no[1:6]-median(df.clear$no[1:6]))/median(df.clear$no[1:6])*100
df.clear$meandiff[7:12] <- (df.clear$no[7:12]-median(df.clear$no[7:12]))/median(df.clear$no[7:12])*100
df.clear$meandiff[13:18] <- (df.clear$no[13:18]-median(df.clear$no[13:18]))/median(df.clear$no[13:18])*100
p_plot_two <- ggplot(df.clear, aes(x=Type, y=meandiff, fill=Evaluation)) +
  geom_bar(stat='identity', position=position_dodge()) +
  theme_minimal() +
  scale_fill_brewer(palette="Dark2") +
  theme(legend.position="bottom") +
  theme(legend.key.size = unit(0.15, 'cm')) +
  guides(fill=guide_legend(nrow=2, byrow=TRUE)) +
  ylab("No. of protein identifications\n Relative deviation from median(type)") +
  labs(fill = "Evaluation \n method")
p_plot_two

df.clear <- df

### - mean
df.clear$meandiff[1:6] <- df.clear$rsd[1:6]-median(df.clear$rsd[1:6])
df.clear$meandiff[7:12] <- df.clear$rsd[7:12]-median(df.clear$rsd[7:12])
df.clear$meandiff[13:18] <- df.clear$rsd[13:18]-median(df.clear$rsd[13:18])
p_plot_two <- ggplot(df.clear, aes(x=Type, y=meandiff, fill=Evaluation)) +
  geom_bar(stat='identity', position=position_dodge()) +
  theme_minimal() +
  scale_fill_brewer(palette="Dark2") +
  theme(legend.position="bottom") +
  theme(legend.key.size = unit(0.15, 'cm')) +
  guides(fill=guide_legend(nrow=2, byrow=TRUE)) +
  ylab("relative sd [%] \n Deviation from median(type)") +
  labs(fill = "Evaluation \n method")
p_plot_two


### - mean/mean *100
df.clear <- df
df.clear$meandiff[1:6] <- (df.clear$rsd[1:6]-median(df.clear$rsd[1:6]))/median(df.clear$rsd[1:6])*100
df.clear$meandiff[7:12] <- (df.clear$rsd[7:12]-median(df.clear$rsd[7:12]))/median(df.clear$rsd[7:12])*100
df.clear$meandiff[13:18] <- (df.clear$rsd[13:18]-median(df.clear$rsd[13:18]))/median(df.clear$rsd[13:18])*100
p_plot_two <- ggplot(df.clear, aes(x=Type, y=meandiff, fill=Evaluation)) +
  geom_bar(stat='identity', position=position_dodge()) +
  theme_minimal() +
  scale_fill_brewer(palette="Dark2") +
  theme(legend.position="bottom") +
  theme(legend.key.size = unit(0.15, 'cm')) +
  guides(fill=guide_legend(nrow=2, byrow=TRUE)) +
  ylab("relative sd [%] \n Relative deviation from median(type)") +
  labs(fill = "Evaluation \n method")
p_plot_two
```



# CONCLUSION one and two peptides

Using at least two razor&unique resp unique peptide as treshhold for the data analysis decreases the number of protein identifications and increases the rsd. MBR has no significant influence on the number of protein identification.

```{r}
df_onepeptide <- readRDS("20220406_TR_QC_summary_rerun_onepeptide.rds")
t <- df_onepeptide$no[-c(13:18)]/df$no[-c(13:18)]
tt <- (1-t[1:12])*100
t_sd <- df_onepeptide$rsd[-c(13:18)]/df$rsd[-c(13:18)]
tt_sd <- (1-t_sd[1:12])*100
df_comp <- as.data.frame(cbind(tt,tt_sd))
colnames(df_comp) <- c("Protein identification","rsd [%]")
df_comp$Typemethod <- df_onepeptide$Type[-c(13:18)]
df_comp$Evaluation <- df_onepeptide$Evaluation[-c(13:18)]
ggplot(melt(df_comp), aes(x=variable, y=value)) + 
  geom_boxplot() +
  geom_point(aes(color = Evaluation)) +
  scale_color_manual(values = rep(c(mypalette_red,mypalette_blue),4)) +
  scale_alpha(0.8) +
  xlab("") +
  ylab("Deviation between one and two peptides [%]") +
  theme(legend.position="bottom") +
  theme(legend.key.size = unit(0.15, 'cm')) +
  guides(colour = guide_legend(ncol=2)) 
ggsave("../pics/QC_rerun_boxplot.png",
       width = 7,
       height = 7)


```
# LaTeX

```{r}
knitr::kable(df, booktabs = T, "latex")
```



# Used time

```{r end, message=FALSE, warning=FALSE, include=FALSE}
end_time = format(Sys.time(), '%X')
```



```{r used time, echo=FALSE, message=TRUE, warning=FALSE}
print(paste("Time used for analysis:", round(as.difftime(end_time, units = "mins")-as.difftime(start_time, units = "mins"),digits=2),"minutes"))
```
